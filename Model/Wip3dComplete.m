



clear all, close all, clc

syms x theta Dtheta Dx
syms DDx DDtheta  F mp mc l g 
WIP=WIP3dModel(9.81);


syms ddpsi_l ddtheta dtheta theta dpsi_l psi_l dpsi_r psi_r 
syms Tr r mw g mp l Te  tau u_l u_r

stab=0;

% g=10;  l=2;  mc=5;
% mp=2; mw=1; r=1;
% tau=F;


g=9.81;


% A=sym(zeros(6,6));
% A(1,2)=1;
% A(2,:)=jacobian(WIP.ddtheta,[theta dtheta psi_r dpsi_r psi_l dpsi_l]);
% A(3,4)=1;
% A(4,:)=jacobian(WIP.ddpsi_l,[theta dtheta psi_r dpsi_r psi_l dpsi_l]);
% A(5,6)=1;
% A(6,:)=jacobian(WIP.ddpsi_r,[theta dtheta psi_r dpsi_r psi_l dpsi_l]);
% 
% 
% B=sym(zeros(6,2));
% B(1)=0;
% B(2,:)=jacobian(WIP.ddtheta,[u_l,u_r]);
% B(4,:)=jacobian(WIP.ddpsi_l,[u_l,u_r]);
% B(6,:)=jacobian(WIP.ddpsi_l,[u_l u_r]);







[A,B]=wip3dlin([stab;0;0;0;0;0]);

Q = [1 0 0 0 0 0;
    0 1 0 0 0 0 ;
    0 0 1 0 0 0;
    0 0 0 1 0 0;
    0 0 0 0 1 0;
    0 0 0 0 0 1 ];
R = [100 0;
    0 100];

pause
% %%

 %K=llqqrr([stab;0;0;0;0;0],Q,R);
 %K=llqqrrr([stab;0;0;0;0;0],Q,R);

%[Abar,Bbar,Cbar ,T,k] = ctrbf(A(1:2,1:2),B(1:2,:),diag([1,1]));
%  K = cat(2,[0,0;0,0],lqr(Abar(3:6,3:6),Bbar(3:6,:),Q(3:6,3:6),R));
%K = lqr(Abar,Bbar,Q(1:2.1:2),R);

%%
% We can use lqr on only the first two vars (theta, dtheta) to get the controls u_l u_r %
K = lqr(A(1:2,1:2),B(1:2,1:2),Q(1:2,1:2),R(1:2,1:2));

%K = lqr(A,B,Q,R); 
disp(K)
pause
s=-1;
disp("start Int")
tspan = 0:.001:10;
if(s==-1)
    y0 = [stab+0.01;0;0;0;0;0];
    [t,y] = ode45(@(t,y)d3wip(y,0,0,0,9.81,0,0,-K*(y(1:2)-[0;0])),tspan,y0);%T*
    %[t,y] = ode45(@(t,y)d3wip(y,0,0,0,9.81,0,0,-K*(y-[stab;0;0;0;0;0])),tspan,y0);
elseif(s==1)
    y0 = [stab+0.001; 0; 0; 0;0;0];
    [t,y] = ode45(@(t,y)d3wip(y,0,0,0,9.81,0,0,[0,0]),tspan,y0);
else
    
end

plot(t,y.')
legend('theta','dtheta','psi_r','dpsi_r','psi_l','dpsi_l')
% for k=1:100:length(t)
%     drawwip(y(k,:),mp,mc,l,r);
% end

%% 

function drawwip(y,m,M,L,r)
x = y(1);
th = -y(3)+pi;

% kinematics
% x = 3;        % cart position
% th = 3*pi/2;   % pendulum angle

% dimensions
% L = 2;  % pendulum length
W = r;  % cart width
H = r; % cart height
wr = 0; % wheel radius
mr = .3*sqrt(m); % mass radius

% positions
% y = wr/2; % cart vertical position
y = wr/2+H/2; % cart vertical position


px = x + L*sin(th);
py = y - L*cos(th);

plot([-10 10],[0 0],'w','LineWidth',2)
hold on
rectangle('Position',[x-W/2,y-H/2,W,H],'Curvature',1,'FaceColor',[1 0.1 0.1],'EdgeColor',[1 1 1])


plot([x px],[y py],'w','LineWidth',2)

rectangle('Position',[px-mr/2,py-mr/2,mr,mr],'Curvature',1,'FaceColor',[.3 0.3 1],'EdgeColor',[1 1 1])

% set(gca,'YTick',[])
% set(gca,'XTick',[])
xlim([-5 5]);
ylim([-2 2.5]);
set(gca,'Color','k','XColor','w','YColor','w')
set(gcf,'Position',[10 900 800 400])
set(gcf,'Color','k')
set(gcf,'InvertHardcopy','off')   

% box off
drawnow
hold off

end
%% 

function dy = d3wip(y,~,~,~,g,~,~,u)
theta=y(1);
dtheta=y(2);
psi_r=y(3);
dpsi_r=y(4);
psi_l=y(5);
dpsi_l=y(6);
u_r=u(1)
u_l=u(2)




dy(1,1) = y(2);
dy(2,1) = (5.0000e-04*(1.0889e+46*u_l + 1.0889e+46*u_r + 4.9001e+42*dtheta^2*sin(theta) + 1.3484e+43*dpsi_l^2*sin(2*theta) + 1.3484e+43*dpsi_r^2*sin(2*theta) - 6.8907e+43*dtheta^2*sin(2*theta) - 3.0625e+47*u_l*cos(theta) - 3.0625e+47*u_r*cos(theta) + 3.4709e+45*g*sin(theta) - 2.6969e+43*dpsi_l*dpsi_r*sin(2*theta)))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40);
dy(3,1) = y(4);
dy(4,1) = -(0.0080*(3.1739e+63*dpsi_l^2*sin(theta) - 3.1032e+68*u_r - 5.6642e+67*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 5.9193e+67*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 2.1808e+68*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 5.6476e+67*u_l*cos(theta) - 7.9074e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) - 1.3169e+63*dpsi_l*dtheta*sin(theta) + 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) - 2.9566e+64*dpsi_l*dtheta*sin(2*theta) - 1.3169e+63*dpsi_l*dtheta*sin(3*theta) + 9.2593e+63*dpsi_l*dtheta*sin(4*theta) + 2.9566e+64*dpsi_r*dtheta*sin(2*theta) + 1.3169e+63*dpsi_r*dtheta*sin(3*theta) - 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62);
dy(5,1) = y(6);
dy(6,1) = -(0.0080*(3.1739e+63*dpsi_l^2*sin(theta) - 5.6642e+67*u_r - 3.1032e+68*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 2.1808e+68*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 5.9193e+67*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 7.9074e+67*u_l*cos(theta) - 5.6476e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) + 1.3169e+63*dpsi_l*dtheta*sin(theta) - 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) + 2.9566e+64*dpsi_l*dtheta*sin(2*theta) + 1.3169e+63*dpsi_l*dtheta*sin(3*theta) - 9.2593e+63*dpsi_l*dtheta*sin(4*theta) - 2.9566e+64*dpsi_r*dtheta*sin(2*theta) - 1.3169e+63*dpsi_r*dtheta*sin(3*theta) + 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62);



end

function [A,B]=wip3dlin(state)

syms x theta Dtheta Dx
syms DDx DDtheta  F mp mc l g 

syms ddpsi_l ddtheta dtheta theta dpsi_l psi_l dpsi_r psi_r 
syms Tr r mw g mp l Te  tau u_l u_r



% g=10;  l=2;  mc=5;
% mp=2; mw=1; r=1;
% tau=F;


g=9.81;
syms ddpsi ddtheta dtheta theta dpsi_l dpsi_r psi_r psi_l
syms u_l u_r 


% WIP.ddtheta = (5.0000e-04*(1.0889e+46*u_l + 1.0889e+46*u_r + 4.9001e+42*dtheta^2*sin(theta) + 1.3484e+43*dpsi_l^2*sin(2*theta) + 1.3484e+43*dpsi_r^2*sin(2*theta) - 6.8907e+43*dtheta^2*sin(2*theta) - 3.0625e+47*u_l*cos(theta) - 3.0625e+47*u_r*cos(theta) + 3.4709e+45*g*sin(theta) - 2.6969e+43*dpsi_l*dpsi_r*sin(2*theta)))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40);
% WIP.ddpsi_r = -(0.0080*(3.1739e+63*dpsi_l^2*sin(theta) - 3.1032e+68*u_r - 5.6642e+67*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 5.9193e+67*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 2.1808e+68*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 5.6476e+67*u_l*cos(theta) - 7.9074e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) - 1.3169e+63*dpsi_l*dtheta*sin(theta) + 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) - 2.9566e+64*dpsi_l*dtheta*sin(2*theta) - 1.3169e+63*dpsi_l*dtheta*sin(3*theta) + 9.2593e+63*dpsi_l*dtheta*sin(4*theta) + 2.9566e+64*dpsi_r*dtheta*sin(2*theta) + 1.3169e+63*dpsi_r*dtheta*sin(3*theta) - 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62);
% WIP.ddpsi_l = -(0.0080*(3.1739e+63*dpsi_l^2*sin(theta) - 5.6642e+67*u_r - 3.1032e+68*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 2.1808e+68*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 5.9193e+67*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 7.9074e+67*u_l*cos(theta) - 5.6476e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) + 1.3169e+63*dpsi_l*dtheta*sin(theta) - 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) + 2.9566e+64*dpsi_l*dtheta*sin(2*theta) + 1.3169e+63*dpsi_l*dtheta*sin(3*theta) - 9.2593e+63*dpsi_l*dtheta*sin(4*theta) - 2.9566e+64*dpsi_r*dtheta*sin(2*theta) - 1.3169e+63*dpsi_r*dtheta*sin(3*theta) + 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62);
% WIP.ddx=(1.5000e-05*cos(0.3000*psi_l - 0.3000*psi_r)*(1.0889e+46*u_l + 1.0889e+46*u_r + 4.9001e+42*dtheta^2*sin(theta) + 1.3484e+43*dpsi_l^2*sin(2*theta) + 1.3484e+43*dpsi_r^2*sin(2*theta) - 6.8907e+43*dtheta^2*sin(2*theta) - 3.0625e+47*u_l*cos(theta) - 3.0625e+47*u_r*cos(theta) + 3.4709e+45*g*sin(theta) - 2.6969e+43*dpsi_l*dpsi_r*sin(2*theta)))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40) - (1.2000e-04*cos(0.3000*psi_l - 0.3000*psi_r)*(3.1739e+63*dpsi_l^2*sin(theta) - 5.6642e+67*u_r - 3.1032e+68*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 2.1808e+68*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 5.9193e+67*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 7.9074e+67*u_l*cos(theta) - 5.6476e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) + 1.3169e+63*dpsi_l*dtheta*sin(theta) - 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) + 2.9566e+64*dpsi_l*dtheta*sin(2*theta) + 1.3169e+63*dpsi_l*dtheta*sin(3*theta) - 9.2593e+63*dpsi_l*dtheta*sin(4*theta) - 2.9566e+64*dpsi_r*dtheta*sin(2*theta) - 1.3169e+63*dpsi_r*dtheta*sin(3*theta) + 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62) - (1.2000e-04*cos(0.3000*psi_l - 0.3000*psi_r)*(3.1739e+63*dpsi_l^2*sin(theta) - 3.1032e+68*u_r - 5.6642e+67*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 5.9193e+67*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 2.1808e+68*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 5.6476e+67*u_l*cos(theta) - 7.9074e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) - 1.3169e+63*dpsi_l*dtheta*sin(theta) + 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) - 2.9566e+64*dpsi_l*dtheta*sin(2*theta) - 1.3169e+63*dpsi_l*dtheta*sin(3*theta) + 9.2593e+63*dpsi_l*dtheta*sin(4*theta) + 2.9566e+64*dpsi_r*dtheta*sin(2*theta) + 1.3169e+63*dpsi_r*dtheta*sin(3*theta) - 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62) - 0.3000*dpsi_l*sin(0.3000*psi_l - 0.3000*psi_r)*(0.0150*dpsi_l + 0.0150*dpsi_r + 0.0300*dtheta) + 0.3000*dpsi_r*sin(0.3000*psi_l - 0.3000*psi_r)*(0.0150*dpsi_l + 0.0150*dpsi_r + 0.0300*dtheta);
% WIP.ddy=(1.2000e-04*sin(0.3000*psi_l - 0.3000*psi_r)*(3.1739e+63*dpsi_l^2*sin(theta) - 3.1032e+68*u_r - 5.6642e+67*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 5.9193e+67*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 2.1808e+68*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 5.6476e+67*u_l*cos(theta) - 7.9074e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) - 1.3169e+63*dpsi_l*dtheta*sin(theta) + 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) - 2.9566e+64*dpsi_l*dtheta*sin(2*theta) - 1.3169e+63*dpsi_l*dtheta*sin(3*theta) + 9.2593e+63*dpsi_l*dtheta*sin(4*theta) + 2.9566e+64*dpsi_r*dtheta*sin(2*theta) + 1.3169e+63*dpsi_r*dtheta*sin(3*theta) - 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62) + (1.2000e-04*sin(0.3000*psi_l - 0.3000*psi_r)*(3.1739e+63*dpsi_l^2*sin(theta) - 5.6642e+67*u_r - 3.1032e+68*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 2.1808e+68*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 5.9193e+67*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 7.9074e+67*u_l*cos(theta) - 5.6476e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) + 1.3169e+63*dpsi_l*dtheta*sin(theta) - 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) + 2.9566e+64*dpsi_l*dtheta*sin(2*theta) + 1.3169e+63*dpsi_l*dtheta*sin(3*theta) - 9.2593e+63*dpsi_l*dtheta*sin(4*theta) - 2.9566e+64*dpsi_r*dtheta*sin(2*theta) - 1.3169e+63*dpsi_r*dtheta*sin(3*theta) + 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62) - (1.5000e-05*sin(0.3000*psi_l - 0.3000*psi_r)*(1.0889e+46*u_l + 1.0889e+46*u_r + 4.9001e+42*dtheta^2*sin(theta) + 1.3484e+43*dpsi_l^2*sin(2*theta) + 1.3484e+43*dpsi_r^2*sin(2*theta) - 6.8907e+43*dtheta^2*sin(2*theta) - 3.0625e+47*u_l*cos(theta) - 3.0625e+47*u_r*cos(theta) + 3.4709e+45*g*sin(theta) - 2.6969e+43*dpsi_l*dpsi_r*sin(2*theta)))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40) - 0.3000*dpsi_l*cos(0.3000*psi_l - 0.3000*psi_r)*(0.0150*dpsi_l + 0.0150*dpsi_r + 0.0300*dtheta) + 0.3000*dpsi_r*cos(0.3000*psi_l - 0.3000*psi_r)*(0.0150*dpsi_l + 0.0150*dpsi_r + 0.0300*dtheta);
% WIP.ddphi=(0.0024*(3.1739e+63*dpsi_l^2*sin(theta) - 5.6642e+67*u_r - 3.1032e+68*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 2.1808e+68*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 5.9193e+67*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 7.9074e+67*u_l*cos(theta) - 5.6476e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) + 1.3169e+63*dpsi_l*dtheta*sin(theta) - 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) + 2.9566e+64*dpsi_l*dtheta*sin(2*theta) + 1.3169e+63*dpsi_l*dtheta*sin(3*theta) - 9.2593e+63*dpsi_l*dtheta*sin(4*theta) - 2.9566e+64*dpsi_r*dtheta*sin(2*theta) - 1.3169e+63*dpsi_r*dtheta*sin(3*theta) + 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62) - (0.0024*(3.1739e+63*dpsi_l^2*sin(theta) - 3.1032e+68*u_r - 5.6642e+67*u_l + 3.1739e+63*dpsi_r^2*sin(theta) - 1.1376e+65*dtheta^2*sin(theta) + 5.9193e+67*u_l*cos(2*theta) + 4.1152e+67*u_l*cos(3*theta) + 2.1808e+68*u_r*cos(2*theta) + 4.1152e+67*u_r*cos(3*theta) + 8.1695e+65*g*sin(2*theta) - 4.4444e+65*g*sin(3*theta) - 3.0864e+65*g*sin(4*theta) + 4.5704e+63*dpsi_l^2*sin(2*theta) + 1.9748e+63*dpsi_l^2*sin(3*theta) - 1.7267e+63*dpsi_l^2*sin(4*theta) - 1.1991e+63*dpsi_l^2*sin(5*theta) + 4.5704e+63*dpsi_r^2*sin(2*theta) + 1.9748e+63*dpsi_r^2*sin(3*theta) - 1.7267e+63*dpsi_r^2*sin(4*theta) - 1.1991e+63*dpsi_r^2*sin(5*theta) - 2.4509e+64*dtheta^2*sin(2*theta) + 3.1193e+64*dtheta^2*sin(3*theta) + 9.2593e+63*dtheta^2*sin(4*theta) - 5.6476e+67*u_l*cos(theta) - 7.9074e+67*u_r*cos(theta) + 1.6209e+66*g*sin(theta) - 6.3477e+63*dpsi_l*dpsi_r*sin(theta) - 1.3169e+63*dpsi_l*dtheta*sin(theta) + 1.3169e+63*dpsi_r*dtheta*sin(theta) - 9.1407e+63*dpsi_l*dpsi_r*sin(2*theta) - 3.9496e+63*dpsi_l*dpsi_r*sin(3*theta) + 3.4533e+63*dpsi_l*dpsi_r*sin(4*theta) + 2.3981e+63*dpsi_l*dpsi_r*sin(5*theta) - 2.9566e+64*dpsi_l*dtheta*sin(2*theta) - 1.3169e+63*dpsi_l*dtheta*sin(3*theta) + 9.2593e+63*dpsi_l*dtheta*sin(4*theta) + 2.9566e+64*dpsi_r*dtheta*sin(2*theta) + 1.3169e+63*dpsi_r*dtheta*sin(3*theta) - 9.2593e+63*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62);




A=[[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      (1.7025e+43*cos(theta) + 1.3484e+40*dpsi_l^2*cos(2*theta) + 1.3484e+40*dpsi_r^2*cos(2*theta) - 6.8907e+40*dtheta^2*cos(2*theta) + 1.5313e+44*u_l*sin(theta) + 1.5313e+44*u_r*sin(theta) + 2.4501e+39*dtheta^2*cos(theta) - 2.6969e+40*dpsi_l*dpsi_r*cos(2*theta))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40) + ((4.9001e+39*sin(theta) - 1.3781e+41*cos(theta)*sin(theta))*(5.4445e+42*u_l + 5.4445e+42*u_r + 1.7025e+43*sin(theta) + 2.4501e+39*dtheta^2*sin(theta) + 6.7420e+39*dpsi_l^2*sin(2*theta) + 6.7420e+39*dpsi_r^2*sin(2*theta) - 3.4453e+40*dtheta^2*sin(2*theta) - 1.5313e+44*u_l*cos(theta) - 1.5313e+44*u_r*cos(theta) - 1.3485e+40*dpsi_l*dpsi_r*sin(2*theta)))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40)^2,                                                                                                                                                                                                                                                                                                                                                                                           -(6.8907e+40*dtheta*sin(2*theta) - 4.9001e+39*dtheta*sin(theta))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40), 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                           -(1.3485e+40*dpsi_l*sin(2*theta) - 1.3484e+40*dpsi_r*sin(2*theta))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40), 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                            (1.3484e+40*dpsi_l*sin(2*theta) - 1.3485e+40*dpsi_r*sin(2*theta))/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40)];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0];
[(1.0464e+65*cos(3*theta) - 1.2823e+65*cos(2*theta) + 9.6888e+64*cos(4*theta) - 1.2721e+65*cos(theta) + 3.4893e+66*u_l*sin(2*theta) + 9.8765e+65*u_l*sin(3*theta) + 9.4709e+65*u_r*sin(2*theta) + 9.8765e+65*u_r*sin(3*theta) - 7.3126e+61*dpsi_l^2*cos(2*theta) - 4.7395e+61*dpsi_l^2*cos(3*theta) + 5.5254e+61*dpsi_l^2*cos(4*theta) + 4.7964e+61*dpsi_l^2*cos(5*theta) - 7.3126e+61*dpsi_r^2*cos(2*theta) - 4.7395e+61*dpsi_r^2*cos(3*theta) + 5.5254e+61*dpsi_r^2*cos(4*theta) + 4.7964e+61*dpsi_r^2*cos(5*theta) + 3.9214e+62*dtheta^2*cos(2*theta) - 7.4863e+62*dtheta^2*cos(3*theta) - 2.9630e+62*dtheta^2*cos(4*theta) - 6.3259e+65*u_l*sin(theta) - 4.5181e+65*u_r*sin(theta) - 2.5391e+61*dpsi_l^2*cos(theta) - 2.5391e+61*dpsi_r^2*cos(theta) + 9.1008e+62*dtheta^2*cos(theta) + 5.0782e+61*dpsi_l*dpsi_r*cos(theta) - 1.0535e+61*dpsi_l*dtheta*cos(theta) + 1.0535e+61*dpsi_r*dtheta*cos(theta) + 1.4625e+62*dpsi_l*dpsi_r*cos(2*theta) + 9.4790e+61*dpsi_l*dpsi_r*cos(3*theta) - 1.1051e+62*dpsi_l*dpsi_r*cos(4*theta) - 9.5924e+61*dpsi_l*dpsi_r*cos(5*theta) - 4.7306e+62*dpsi_l*dtheta*cos(2*theta) - 3.1606e+61*dpsi_l*dtheta*cos(3*theta) + 2.9630e+62*dpsi_l*dtheta*cos(4*theta) + 4.7306e+62*dpsi_r*dtheta*cos(2*theta) + 3.1606e+61*dpsi_r*dtheta*cos(3*theta) - 2.9630e+62*dpsi_r*dtheta*cos(4*theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62) - ((4.8955e+61*sin(theta) - 2.9156e+63*cos(theta)*sin(theta) - 1.2642e+62*cos(theta)^2*sin(theta) + 2.3704e+63*cos(theta)^3*sin(theta))*(6.4114e+64*sin(2*theta) - 4.5314e+65*u_r - 2.4826e+66*u_l - 3.4880e+64*sin(3*theta) - 2.4222e+64*sin(4*theta) + 1.2721e+65*sin(theta) + 2.5391e+61*dpsi_l^2*sin(theta) + 2.5391e+61*dpsi_r^2*sin(theta) - 9.1008e+62*dtheta^2*sin(theta) + 1.7446e+66*u_l*cos(2*theta) + 3.2922e+65*u_l*cos(3*theta) + 4.7354e+65*u_r*cos(2*theta) + 3.2922e+65*u_r*cos(3*theta) + 3.6563e+61*dpsi_l^2*sin(2*theta) + 1.5798e+61*dpsi_l^2*sin(3*theta) - 1.3814e+61*dpsi_l^2*sin(4*theta) - 9.5928e+60*dpsi_l^2*sin(5*theta) + 3.6563e+61*dpsi_r^2*sin(2*theta) + 1.5798e+61*dpsi_r^2*sin(3*theta) - 1.3814e+61*dpsi_r^2*sin(4*theta) - 9.5928e+60*dpsi_r^2*sin(5*theta) - 1.9607e+62*dtheta^2*sin(2*theta) + 2.4954e+62*dtheta^2*sin(3*theta) + 7.4074e+61*dtheta^2*sin(4*theta) - 6.3259e+65*u_l*cos(theta) - 4.5181e+65*u_r*cos(theta) - 5.0782e+61*dpsi_l*dpsi_r*sin(theta) + 1.0535e+61*dpsi_l*dtheta*sin(theta) - 1.0535e+61*dpsi_r*dtheta*sin(theta) - 7.3126e+61*dpsi_l*dpsi_r*sin(2*theta) - 3.1597e+61*dpsi_l*dpsi_r*sin(3*theta) + 2.7626e+61*dpsi_l*dpsi_r*sin(4*theta) + 1.9185e+61*dpsi_l*dpsi_r*sin(5*theta) + 2.3653e+62*dpsi_l*dtheta*sin(2*theta) + 1.0535e+61*dpsi_l*dtheta*sin(3*theta) - 7.4074e+61*dpsi_l*dtheta*sin(4*theta) - 2.3653e+62*dpsi_r*dtheta*sin(2*theta) - 1.0535e+61*dpsi_r*dtheta*sin(3*theta) + 7.4074e+61*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62)^2, -(2.3653e+62*dpsi_l*sin(2*theta) + 1.0535e+61*dpsi_l*sin(3*theta) - 7.4074e+61*dpsi_l*sin(4*theta) - 2.3653e+62*dpsi_r*sin(2*theta) - 1.0535e+61*dpsi_r*sin(3*theta) + 7.4074e+61*dpsi_r*sin(4*theta) - 3.9214e+62*dtheta*sin(2*theta) + 4.9909e+62*dtheta*sin(3*theta) + 1.4815e+62*dtheta*sin(4*theta) + 1.0535e+61*dpsi_l*sin(theta) - 1.0535e+61*dpsi_r*sin(theta) - 1.8202e+63*dtheta*sin(theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62), 0,  (7.3126e+61*dpsi_l*sin(2*theta) + 3.1597e+61*dpsi_l*sin(3*theta) - 2.7626e+61*dpsi_l*sin(4*theta) - 1.9185e+61*dpsi_l*sin(5*theta) - 7.3126e+61*dpsi_r*sin(2*theta) - 3.1597e+61*dpsi_r*sin(3*theta) + 2.7627e+61*dpsi_r*sin(4*theta) + 1.9186e+61*dpsi_r*sin(5*theta) + 2.3653e+62*dtheta*sin(2*theta) + 1.0535e+61*dtheta*sin(3*theta) - 7.4074e+61*dtheta*sin(4*theta) + 5.0782e+61*dpsi_l*sin(theta) - 5.0782e+61*dpsi_r*sin(theta) + 1.0535e+61*dtheta*sin(theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62), 0, -(7.3126e+61*dpsi_l*sin(2*theta) + 3.1597e+61*dpsi_l*sin(3*theta) - 2.7627e+61*dpsi_l*sin(4*theta) - 1.9186e+61*dpsi_l*sin(5*theta) - 7.3126e+61*dpsi_r*sin(2*theta) - 3.1597e+61*dpsi_r*sin(3*theta) + 2.7626e+61*dpsi_r*sin(4*theta) + 1.9185e+61*dpsi_r*sin(5*theta) + 2.3653e+62*dtheta*sin(2*theta) + 1.0535e+61*dtheta*sin(3*theta) - 7.4074e+61*dtheta*sin(4*theta) + 5.0782e+61*dpsi_l*sin(theta) - 5.0782e+61*dpsi_r*sin(theta) + 1.0535e+61*dtheta*sin(theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62)];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1];
[(1.0464e+65*cos(3*theta) - 1.2823e+65*cos(2*theta) + 9.6888e+64*cos(4*theta) - 1.2721e+65*cos(theta) + 9.4709e+65*u_l*sin(2*theta) + 9.8765e+65*u_l*sin(3*theta) + 3.4893e+66*u_r*sin(2*theta) + 9.8765e+65*u_r*sin(3*theta) - 7.3126e+61*dpsi_l^2*cos(2*theta) - 4.7395e+61*dpsi_l^2*cos(3*theta) + 5.5254e+61*dpsi_l^2*cos(4*theta) + 4.7964e+61*dpsi_l^2*cos(5*theta) - 7.3126e+61*dpsi_r^2*cos(2*theta) - 4.7395e+61*dpsi_r^2*cos(3*theta) + 5.5254e+61*dpsi_r^2*cos(4*theta) + 4.7964e+61*dpsi_r^2*cos(5*theta) + 3.9214e+62*dtheta^2*cos(2*theta) - 7.4863e+62*dtheta^2*cos(3*theta) - 2.9630e+62*dtheta^2*cos(4*theta) - 4.5181e+65*u_l*sin(theta) - 6.3259e+65*u_r*sin(theta) - 2.5391e+61*dpsi_l^2*cos(theta) - 2.5391e+61*dpsi_r^2*cos(theta) + 9.1008e+62*dtheta^2*cos(theta) + 5.0782e+61*dpsi_l*dpsi_r*cos(theta) + 1.0535e+61*dpsi_l*dtheta*cos(theta) - 1.0535e+61*dpsi_r*dtheta*cos(theta) + 1.4625e+62*dpsi_l*dpsi_r*cos(2*theta) + 9.4790e+61*dpsi_l*dpsi_r*cos(3*theta) - 1.1051e+62*dpsi_l*dpsi_r*cos(4*theta) - 9.5924e+61*dpsi_l*dpsi_r*cos(5*theta) + 4.7306e+62*dpsi_l*dtheta*cos(2*theta) + 3.1606e+61*dpsi_l*dtheta*cos(3*theta) - 2.9630e+62*dpsi_l*dtheta*cos(4*theta) - 4.7306e+62*dpsi_r*dtheta*cos(2*theta) - 3.1606e+61*dpsi_r*dtheta*cos(3*theta) + 2.9630e+62*dpsi_r*dtheta*cos(4*theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62) - ((4.8955e+61*sin(theta) - 2.9156e+63*cos(theta)*sin(theta) - 1.2642e+62*cos(theta)^2*sin(theta) + 2.3704e+63*cos(theta)^3*sin(theta))*(6.4114e+64*sin(2*theta) - 2.4826e+66*u_r - 4.5314e+65*u_l - 3.4880e+64*sin(3*theta) - 2.4222e+64*sin(4*theta) + 1.2721e+65*sin(theta) + 2.5391e+61*dpsi_l^2*sin(theta) + 2.5391e+61*dpsi_r^2*sin(theta) - 9.1008e+62*dtheta^2*sin(theta) + 4.7354e+65*u_l*cos(2*theta) + 3.2922e+65*u_l*cos(3*theta) + 1.7446e+66*u_r*cos(2*theta) + 3.2922e+65*u_r*cos(3*theta) + 3.6563e+61*dpsi_l^2*sin(2*theta) + 1.5798e+61*dpsi_l^2*sin(3*theta) - 1.3814e+61*dpsi_l^2*sin(4*theta) - 9.5928e+60*dpsi_l^2*sin(5*theta) + 3.6563e+61*dpsi_r^2*sin(2*theta) + 1.5798e+61*dpsi_r^2*sin(3*theta) - 1.3814e+61*dpsi_r^2*sin(4*theta) - 9.5928e+60*dpsi_r^2*sin(5*theta) - 1.9607e+62*dtheta^2*sin(2*theta) + 2.4954e+62*dtheta^2*sin(3*theta) + 7.4074e+61*dtheta^2*sin(4*theta) - 4.5181e+65*u_l*cos(theta) - 6.3259e+65*u_r*cos(theta) - 5.0782e+61*dpsi_l*dpsi_r*sin(theta) - 1.0535e+61*dpsi_l*dtheta*sin(theta) + 1.0535e+61*dpsi_r*dtheta*sin(theta) - 7.3126e+61*dpsi_l*dpsi_r*sin(2*theta) - 3.1597e+61*dpsi_l*dpsi_r*sin(3*theta) + 2.7626e+61*dpsi_l*dpsi_r*sin(4*theta) + 1.9185e+61*dpsi_l*dpsi_r*sin(5*theta) - 2.3653e+62*dpsi_l*dtheta*sin(2*theta) - 1.0535e+61*dpsi_l*dtheta*sin(3*theta) + 7.4074e+61*dpsi_l*dtheta*sin(4*theta) + 2.3653e+62*dpsi_r*dtheta*sin(2*theta) + 1.0535e+61*dpsi_r*dtheta*sin(3*theta) - 7.4074e+61*dpsi_r*dtheta*sin(4*theta)))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62)^2,  (2.3653e+62*dpsi_l*sin(2*theta) + 1.0535e+61*dpsi_l*sin(3*theta) - 7.4074e+61*dpsi_l*sin(4*theta) - 2.3653e+62*dpsi_r*sin(2*theta) - 1.0535e+61*dpsi_r*sin(3*theta) + 7.4074e+61*dpsi_r*sin(4*theta) + 3.9214e+62*dtheta*sin(2*theta) - 4.9909e+62*dtheta*sin(3*theta) - 1.4815e+62*dtheta*sin(4*theta) + 1.0535e+61*dpsi_l*sin(theta) - 1.0535e+61*dpsi_r*sin(theta) + 1.8202e+63*dtheta*sin(theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62), 0, -(2.7626e+61*dpsi_l*sin(4*theta) - 3.1597e+61*dpsi_l*sin(3*theta) - 7.3126e+61*dpsi_l*sin(2*theta) + 1.9185e+61*dpsi_l*sin(5*theta) + 7.3126e+61*dpsi_r*sin(2*theta) + 3.1597e+61*dpsi_r*sin(3*theta) - 2.7627e+61*dpsi_r*sin(4*theta) - 1.9186e+61*dpsi_r*sin(5*theta) + 2.3653e+62*dtheta*sin(2*theta) + 1.0535e+61*dtheta*sin(3*theta) - 7.4074e+61*dtheta*sin(4*theta) - 5.0782e+61*dpsi_l*sin(theta) + 5.0782e+61*dpsi_r*sin(theta) + 1.0535e+61*dtheta*sin(theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62), 0,  (2.7627e+61*dpsi_l*sin(4*theta) - 3.1597e+61*dpsi_l*sin(3*theta) - 7.3126e+61*dpsi_l*sin(2*theta) + 1.9186e+61*dpsi_l*sin(5*theta) + 7.3126e+61*dpsi_r*sin(2*theta) + 3.1597e+61*dpsi_r*sin(3*theta) - 2.7626e+61*dpsi_r*sin(4*theta) - 1.9185e+61*dpsi_r*sin(5*theta) + 2.3653e+62*dtheta*sin(2*theta) + 1.0535e+61*dtheta*sin(3*theta) - 7.4074e+61*dtheta*sin(4*theta) - 5.0782e+61*dpsi_l*sin(theta) + 5.0782e+61*dpsi_r*sin(theta) + 1.0535e+61*dtheta*sin(theta))/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62)]];
 

B=[[                                                                                                                                                                                                           0,                                                                                                                                                                                                            0];
[                                                                                                        -(1.5313e+44*cos(theta) - 5.4445e+42)/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40),                                                                                                         -(1.5313e+44*cos(theta) - 5.4445e+42)/(4.9001e+39*cos(theta) - 6.8907e+40*cos(theta)^2 + 8.9462e+40)];
[                                                                                                                                                                                                           0,                                                                                                                                                                                                            0];
[-(1.7446e+66*cos(2*theta) + 3.2922e+65*cos(3*theta) - 6.3259e+65*cos(theta) - 2.4826e+66)/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62), -(4.7354e+65*cos(2*theta) + 3.2922e+65*cos(3*theta) - 4.5181e+65*cos(theta) - 4.5314e+65)/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62)];
[                                                                                                                                                                                                           0,                                                                                                                                                                                                            0];
[-(1.7446e+66*cos(2*theta) + 3.2922e+65*cos(3*theta) - 6.3259e+65*cos(theta) - 2.4826e+66)/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62), -(4.7354e+65*cos(2*theta) + 3.2922e+65*cos(3*theta) - 4.5181e+65*cos(theta) - 4.5314e+65)/(4.8955e+61*cos(theta) - 1.4578e+63*cos(theta)^2 - 4.2140e+61*cos(theta)^3 + 5.9259e+62*cos(theta)^4 + 8.9379e+62)]];


A=subs(A,[theta dtheta psi_r dpsi_r psi_l dpsi_l u_r u_l],[state.', 0 0]);

B=subs(B,[theta dtheta psi_r dpsi_r psi_l dpsi_l u_r u_l],[state.', 0 0]);

A=double(A);
B=double(B);
end

function K=llqqrr(state,Q,R)

[A,B]=wip3dlin(state);
dim=length(state);
[Abar,Bbar,Cbar ,T,k] = ctrbf(A,B,eye(dim));
 CTr=dim-sum(k)+1;
 K = cat(2,zeros(2,CTr-1),lqr(Abar(CTr:dim,CTr:dim),Bbar(CTr:dim,:),Q(CTr:dim,CTr:dim),R))*T;
end
function K=llqqrrr(state,Q,R)

[A,B]=wip3dlin(state);
dim=length(state);
[Abar,Bbar,Cbar ,T,k] = ctrbf(A,B,eye(dim));

 K = lqr(Abar,Bbar,Q,R)*T;
end